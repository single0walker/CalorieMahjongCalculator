<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Calorie Mahjong Calculator</title>
  <style>
    html{
      font-size: calc((100 / 1920)*100vw*0.16);
    }
    h1{
      margin-bottom: 2rem ;
    }
    body{
      width: 100%;
      /* height: 100vh; */
      margin: 0px;
      padding: 0;
      padding-top: 2rem;
      background-color: #000;
      color: rgb(0, 255, 0);
    }
    ul,
    h4,
    h5 {
      margin: 0;
    }

    h3 {
      margin-top: 1.8rem;
      margin-bottom: 0px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 1rem;
      margin-top: 1.8rem;
    }

    td,
    th {
      border: 1px solid rgb(0, 255, 0);
      background-color: #000;
      color: rgb(0, 255, 0);
      /* padding: 8px; */
      height: 3rem;
      text-align: center;
      font-size: 2.4rem;
    }

    input[type="number"] {
      width: 25rem;
      height: 100%;
      border: 0;
      text-align: center;
      background-color: transparent;
      color: rgb(0, 255, 0);
      border: 0;
      outline: none;
      font-size: 2.4rem;
    }

    .ul>li {
      font-size: 0.8rem;
      color: #999;
    }

    .readonly {
      background-color: rgb(0, 255, 0);
      color: #000;
      border: #000 1px solid;
    }
    #emoji-container {
      position: absolute;
      pointer-events: none;
      width: 100vw;
      height: 100vh;
    }

    .emoji {
      position: absolute;
      font-size: 4rem;
      animation: fly 2s forwards;
    }
    .label{
      font-size: 1.6rem;
      vertical-align: middle;
    }
    button{
      background-color: #000;
      border: 1px solid rgb(0, 255, 0);
      width: 10rem;
      height: 2.5rem;
      color: rgb(0, 255, 0);
      border-radius: 1rem;
      font-size: 1.6rem;
    }
    @keyframes fly {
      0% {
        transform: scale(1) translate(0, 0);
        opacity: 1;
      }

      100% {
        transform: scale(1.5) translate(var(--x), var(--y));
        opacity: 0;
      }
    }
    .checkbox{
      -webkit-appearance: none;
      -moz-appearance: none;
      outline: none;
      width: 1.5rem;
      height: 1.5rem;
      display: inline-block;
      background-color: #000;
      border: rgb(0, 255, 0) 1px solid;
      border-radius: 1.5rem;
      vertical-align: middle;
    }
    .checkbox:checked{
      background-color: rgb(0, 255, 0);
      vertical-align: middle;
    }
  </style>
</head>

<body  >
  <!-- <div id="emoji-container"></div> -->
  <h1 style="text-align: center;margin-top: 0;">Calorie Mahjong Calculator</h1>
  <div style="display: flex;justify-content: center;gap: 20px;">
    <label><input type="checkbox" id="useRandom" class="checkbox" onchange="saveToCookies()"> <span class="label">æ˜¯å¦å¼€å¯éšæœºæ•°</span> </label>
    <label><input type="checkbox" id="useRandom2" class="checkbox" onchange="saveToCookies()"> <span class="label">æ˜¯å¦å¼€å¯éšæœºåŠ æ•°</span> </label>
    <button onclick="calculate()">è®¡ç®—</button>
    <button onclick="addRow()">æ·»åŠ æ•°æ®è¡Œ</button>
    <button onclick="clearAll()">æ¸…ç©º</button>
  </div>
  <table id="dataTable">
    <thead>
      <tr id="headerRow">
        <th>é¡¹ç›®</th>
        <td ondblclick="editName(this, 0)">äººå1</td>
        <td ondblclick="editName(this, 1)">äººå2</td>
        <td ondblclick="editName(this, 2)">äººå3</td>
        <td ondblclick="editName(this, 3)">äººå4</td>
      </tr>
    </thead>
    <tbody id="inputRows">
      <tr>
        <th>ç¬¬1å±€</th>
        <td><input type="number" min="0" oninput="saveToCookies()"></td>
        <td><input type="number" min="0" oninput="saveToCookies()"></td>
        <td><input type="number" min="0" oninput="saveToCookies()"></td>
        <td><input type="number" min="0" oninput="saveToCookies()"></td>
      </tr>
    </tbody>
    <tfoot>
      <tr id="randomAddRow">
        <th>éšæœºåŠ æ•°</th>
        <td class="readonly"></td>
        <td class="readonly"></td>
        <td class="readonly"></td>
        <td class="readonly"></td>
      </tr>
      <tr id="randomRow">
        <th>éšæœºæ•°</th>
        <td class="readonly"></td>
        <td class="readonly"></td>
        <td class="readonly"></td>
        <td class="readonly"></td>
      </tr>
      <tr id="sumRow">
        <th>æ€»å’Œ</th>
        <td class="readonly"></td>
        <td class="readonly"></td>
        <td class="readonly"></td>
        <td class="readonly"></td>
      </tr>
    </tfoot>
  </table>
  <div>
    <h3>Random Number Probability Formula</h3>
    <ul>
      <li>Range: [0.00, 10.00]</li>
      <li>Increase 89.91%</li>
      <li>Decrease or No Change 9.99%</li>
      <li>Forgiveness 0.1%</li>
    </ul>
  </div>
  <div>
    <h3>Random Add Number Probability Formula</h3>
    <ul>
      <li>Range: [0.00, 25.00]</li>
      <li>Increase 95.96%</li>
      <li>Decrease or No Change 4%</li>
      <li>Forgiveness 0.04%</li>
    </ul>
  </div>
  <div>
    <h3>Thank the author ( Click to enlarge )</h3>
    <p style="text-indent:2em;">
      <img src="img.png" alt="" width="100px" onclick="this.style.width = this.style.width === '300px' ? '100px' : '300px'">
    </p>
    
  </div>
  <div>
    
    <h3>Update Log</h3>
    <ul>
      <li>
        <h5>06/15/2025</h5>
        <ul class="ul">
          <li>Changed the entire webpage's theme to express my anger</li>
        </ul>
      </li>
      <li>
        <h5>06/11/2025</h5>
        <ul class="ul">
          <li>Add Easter Egg</li>
        </ul>
      </li>
      <li>
        <h5>06/10/2025</h5>
        <ul class="ul">
          <li>Apply the same restriction to the name in the cookie</li>
        </ul>
      </li>
      <li>
        <h5>06/09/2025</h5>
        <ul class="ul">
          <li>Add random increment, there will be a penalty even with a full win</li>
          <li>No way to escape</li>
          <li>Good luck :P</li>
        </ul>
      </li>
      <li>
        <h5>06/09/2025</h5>
        <ul class="ul">
          <li>Rounded random numbers to two decimal places</li>
          <li>Added probability formula</li>
          <li>Changed naming conventions</li>
        </ul>
      </li>
    </ul>

  </div>
  <script>
    let randomGenerated = false;
    let randomGenerated2 = false;
    let randomValues = [];
    let randomValues2 = [];

    // === å¯ç¼–è¾‘äººå ===
    function editName(cell, index) {
      const currentName = cell.innerText;
      const input = document.createElement("input");
      input.type = "text";
      input.value = currentName;
      input.onblur = function () {
        const maxLength = 6;
        let inputValue = this.value;
        let str = handleTextLength(inputValue, maxLength);
        cell.innerText = str || currentName;
        cell.ondblclick = () => editName(cell, index);
        saveToCookies();
      };
      cell.innerText = "";
      cell.appendChild(input);
      input.focus();
    }
    function calculateStringLength(str) {
      let length = 0;
      for (let i = 0; i < str.length; i++) {
        const charCode = str.charCodeAt(i);
        // å‡è®¾è‹±æ–‡å­—ç¬¦çš„ASCIIç èŒƒå›´æ˜¯32åˆ°126
        if (charCode >= 32 && charCode <= 126) {
          length += 0.5; // è‹±æ–‡å­—ç¬¦ç®—ä½œåŠä¸ªé•¿åº¦
        } else {
          length += 1; // å…¶ä»–å­—ç¬¦ç®—ä½œä¸€ä¸ªé•¿åº¦
        }
      }
      return length;
    }
    function handleTextLength(text, maxLength) {
      let length = 0;
      let result = '';
      if (calculateStringLength(text) > 10) {
        return 'è¿™ä¹ˆé•¿åç»™è°çœ‹';
      }
      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        length += (calculateStringLength(char) === 0.5) ? 0.5 : 1;  // è‹±æ–‡å­—ç¬¦ä¸º0.5ï¼Œå…¶ä»–ä¸º1

        if (length > maxLength) {
          break;  // å¦‚æœè¶…å‡ºæœ€å¤§é•¿åº¦ï¼Œåœæ­¢
        }

        result += char;
      }

      return result;
    }
    // === æ·»åŠ æ•°æ®è¡Œ ===
    function addRow() {
      const inputRows = document.getElementById("inputRows");
      const rowCount = inputRows.rows.length + 1;
      const newRow = document.createElement("tr");

      const headerCell = document.createElement("th");
      headerCell.textContent = `ç¬¬${rowCount}å±€`;
      newRow.appendChild(headerCell);

      for (let i = 0; i < 4; i++) {
        const cell = document.createElement("td");
        const input = document.createElement("input");
        input.type = "number";
        input.min = 0;
        input.oninput = saveToCookies;
        cell.appendChild(input);
        newRow.appendChild(cell);
      }

      inputRows.appendChild(newRow);
      saveToCookies();
    }

    // === è®¡ç®—é€»è¾‘ ===
    function calculate() {
      const useRandom = document.getElementById("useRandom").checked;
      const useRandom2 = document.getElementById("useRandom2").checked;
      const inputRows = document.getElementById("inputRows").rows;
      const sumRow = document.getElementById("sumRow").cells;
      const randomRow = document.getElementById("randomRow").cells;
      const randomRow2 = document.getElementById("randomAddRow").cells;

      if (!randomGenerated) {
        randomValues = [];
        randomValues2 = [];
        for (let i = 1; i <= 4; i++) {
          const rand = parseFloat((Math.random() * 10).toFixed(2));
          randomValues.push(rand);
          randomRow[i].textContent = rand;
        }
        randomGenerated = true;
        saveToCookies();
      }
      if (!randomGenerated2) {
        console.log('randomValues2');
        randomValues2 = [];
        for (let i = 1; i <= 4; i++) {
          const rand2 = parseFloat((Math.random() * 25).toFixed(2));
          randomValues2.push(rand2);
          randomRow2[i].textContent = rand2;
        }
        randomGenerated2 = true;
        saveToCookies();
      }

      for (let col = 1; col <= 4; col++) {
        let sum = 0;
        if (!isNaN(randomValues2[col - 1]) && useRandom2) {
          sum += randomValues2[col - 1]
        }
        for (let row = 0; row < inputRows.length; row++) {
          const input = inputRows[row].cells[col].querySelector("input");
          const value = parseFloat(input.value);
          if (!isNaN(value)) sum += value;
        }
        if (useRandom) {
          sum *= randomValues[col - 1];
        }
        console.log('sum', sum);
        sumRow[col].textContent = sum.toFixed(2);
      }
    }

    // === ä¿å­˜åˆ° cookie ===
    function saveToCookies() {
      const data = {
        names: [],
        inputs: [],
        randomValues: randomValues,
        randomValues2: randomValues2,
        useRandom: document.getElementById("useRandom").checked,
        useRandom2: document.getElementById("useRandom2").checked
      };

      // ä¿å­˜äººå
      const headerCells = document.querySelectorAll("#headerRow td");
      headerCells.forEach(cell => data.names.push(cell.innerText));

      // ä¿å­˜è¾“å…¥æ•°æ®
      const inputRows = document.getElementById("inputRows").rows;
      for (let i = 0; i < inputRows.length; i++) {
        const row = inputRows[i];
        const rowData = [];
        for (let j = 1; j <= 4; j++) {
          const input = row.cells[j].querySelector("input");
          rowData.push(input.value);
        }
        data.inputs.push(rowData);
      }

      document.cookie = "tableData=" + encodeURIComponent(JSON.stringify(data)) + ";path=/;max-age=31536000";
    }

    // === åŠ è½½ cookie ===
    function loadFromCookies() {
      const cookie = document.cookie.split("; ").find(row => row.startsWith("tableData="));
      if (!cookie) return;

      try {
        const data = JSON.parse(decodeURIComponent(cookie.split("=")[1]));

        // è®¾ç½®äººå
        const headerCells = document.querySelectorAll("#headerRow td");
        data.names.forEach((name, i) => {
          if (headerCells[i]) headerCells[i].innerText = handleTextLength(name, 6);
        });

        // æ·»åŠ è¡Œå¹¶å¡«å…¥æ•°æ®
        const tbody = document.getElementById("inputRows");
        while (tbody.rows.length < data.inputs.length) {
          addRow();
        }

        for (let i = 0; i < data.inputs.length; i++) {
          for (let j = 0; j < 4; j++) {
            const cell = tbody.rows[i].cells[j + 1];
            const input = cell.querySelector("input");
            input.value = data.inputs[i][j];
          }
        }

        // æ¢å¤éšæœºæ•°
        if (data.randomValues && data.randomValues.length === 4) {
          randomValues = data.randomValues;
          randomGenerated = true;
          const randomRow = document.getElementById("randomRow").cells;
          for (let i = 1; i <= 4; i++) {
            randomRow[i].textContent = randomValues[i - 1];
          }
        }
        if (data.randomValues2 && data.randomValues2.length === 4) {
          randomValues2 = data.randomValues2;
          randomGenerated2 = true;
          const randomRow2 = document.getElementById("randomAddRow").cells;
          for (let i = 1; i <= 4; i++) {
            randomRow2[i].textContent = randomValues2[i - 1];
          }
        }

        // æ¢å¤éšæœºæ•°é€‰é¡¹
        document.getElementById("useRandom").checked = data.useRandom;
        document.getElementById("useRandom2").checked = data.useRandom2;
      } catch (e) {
        console.error("è§£æ cookie æ•°æ®å¤±è´¥ï¼š", e);
      }
    }

    // === æ¸…ç©ºæ•°æ® ===
    function clearAll() {
      document.cookie = "tableData=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
      location.reload();
    }

    window.onload = loadFromCookies;
    const emojiContainer = document.getElementById('emoji-container');
    const emojis = ['ğŸ˜Š', 'ğŸ˜‚', 'ğŸ˜', 'ğŸ¥º', 'ğŸ˜', 'ğŸ¤”', 'ğŸ˜œ', 'ğŸ™ƒ', 'ğŸ˜‡'];
    document.body.addEventListener('click', (e) => {
      // è·å–ç‚¹å‡»ä½ç½®
      const x = e.clientX;
      const y = e.clientY-25;

      // éšæœºé€‰æ‹©ä¸€ä¸ª emoji
      const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];

      // åˆ›å»º emoji å…ƒç´ 
      const emoji = document.createElement('div');
      emoji.classList.add('emoji');
      emoji.textContent = randomEmoji;
      
      // éšæœºç”Ÿæˆç›®æ ‡ä½ç½®ï¼ˆé£å‡ºçš„æ–¹å‘ï¼‰
      const randomX = Math.random() * 100-50 ;  // éšæœºæ°´å¹³åç§»
      const randomY = -Math.random() * 100 ;  // éšæœºå‚ç›´åç§»

      // è®¾ç½®åŠ¨ç”»çš„ç›®æ ‡ä½ç½®
      emoji.style.setProperty('--x', `${randomX}px`);
      emoji.style.setProperty('--y', `${randomY}px`);
      emoji.style.userSelect = 'none';
      // è®¾ç½® emoji åˆå§‹ä½ç½®
      emoji.style.left = `${x - 12}px`;  // å‡å» emoji å®½åº¦çš„ä¸€åŠ
      emoji.style.top = `${y - 12}px`;   // å‡å» emoji é«˜åº¦çš„ä¸€åŠ

      // æ·»åŠ åˆ°å®¹å™¨ä¸­
      document.body.appendChild(emoji);

      // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
      emoji.addEventListener('animationend', () => {
        emoji.remove();
      });
    });
  </script>

</body>

</html>